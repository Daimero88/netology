version: 3
projects:
  - name: infra
    dir: infrastructure
    workspace: default
    autoplan:
      enabled: true
      when_modified:
        - "*.tf"
        - "**/*.tf"
        - "*.tfvars"
        - "**/*.tfvars"
    apply_requirements:
      - approved
      - mergeable
    workflow: default
    workflows:
      custom:
        plan:
          steps:
            - run: mkdir -p /tmp/terraform-plugins
            - init:
                extra_args: ["-backend-config=backend.hcl"]
                extra_args: ["-plugin-dir=/tmp/terraform-plugins"]
            - plan
          apply:
            steps:
            - apply
